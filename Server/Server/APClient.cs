using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static System.Collections.Specialized.BitVector32;
using System.Net;
using System.Collections;
using Shared;
using Shared.Packet;
using Shared.Packet.Packets;
using Archipelago;
using Archipelago.MultiClient;
using Archipelago.MultiClient.Net;
using Archipelago.MultiClient.Net.Enums;
using Archipelago.MultiClient.Net.Helpers;
using Archipelago.MultiClient.Net.Packets;
using Archipelago.MultiClient.Net.Models;
using Archipelago.MultiClient.Net.BounceFeatures.DeathLink;

namespace Server
{
    
    public class APClient
    {
        public ArchipelagoSession session;
        public bool loginFailed = false;
        public LoginResult result;
        public LoginSuccessful loginSuccessful;
        public ItemInfo lastReceivedItem;
        public HashSet<long> preconnectChecks = new HashSet<long>();
        public DeathLinkService deathLink;

        public struct Goal
        {
            public string item;
            public int index;
        }

        public static readonly Dictionary<string, int> shopItems = new Dictionary<string, int>()
        {
            {"MarioInvisibleCap", 2502},
            {"MarioCaptainCap", 2503},
            {"MarioTailCoatCap", 2504},
            {"MarioTailCoatClothes", 2505},
            {"StickerCap", 2506},
            {"SouvenirHat1", 2507},
            {"SouvenirHat2", 2508},
            {"MarioPrimitiveManCap", 2509},
            {"MarioPrimitiveManClothes", 2510},
            {"StickerWaterfall", 2511},
            {"SouvenirFall1", 2512},
            {"SouvenirFall2", 2513},
            {"MarioPonchoCap", 2514},
            {"MarioPonchoClothes", 2515},
            {"MarioGunmanCap", 2516},
            {"MarioGunmanClothes", 2517},
            {"StickerSand", 2518},
            {"SouvenirSand2", 2519},
            {"SouvenirSand1", 2520},
            {"MarioSwimwearCap", 2521},
            {"MarioSwimwearClothes", 2522},
            {"StickerLake", 2523},
            {"SouvenirLake2", 2524},
            {"SouvenirLake1", 2525},
            {"MarioExplorerCap", 2526},
            {"MarioExplorerClothes", 2527},
            {"MarioScientistCap", 2528},
            {"MarioScientistClothes", 2529},
            {"StickerForest", 2530},
            {"SouvenirForest1", 2531},
            {"SouvenirForest2", 2532},
            {"MarioPilotCap", 2533},
            {"MarioPilotClothes", 2534},
            {"StickerClash", 2535},
            {"SouvenirCrash1", 2536},
            {"SouvenirCrash2", 2537},
            {"MarioMakerCap", 2538},
            {"MarioMakerClothes", 2539},
            {"MarioGolfCap", 2540},
            {"MarioGolfClothes", 2541},
            {"StickerCity", 2542},
            {"SouvenirCity2", 2543},
            {"SouvenirCity1", 2544},
            {"MarioSnowSuitCap", 2545},
            {"MarioSnowSuitClothes", 2546},
            {"StickerSnow", 2547},
            {"SouvenirSnow1", 2548},
            {"SouvenirSnow2", 2549},
            {"MarioAlohaCap", 2550},
            {"MarioAlohaClothes", 2551},
            {"MarioSailorCap", 2552},
            {"MarioSailorClothes", 2553},
            {"StickerSea", 2554},
            {"SouvenirSea2", 2555},
            {"SouvenirSea1", 2556},
            {"MarioCookCap", 2557},
            {"MarioCookClothes", 2558},
            {"MarioPainterCap", 2559},
            {"MarioPainterClothes", 2560},
            {"StickerLava", 2561},
            {"SouvenirLava1", 2562},
            {"SouvenirLava2", 2563},
            {"MarioArmorCap", 2564},
            {"MarioArmorClothes", 2565},
            {"MarioHappiCap", 2566},
            {"MarioHappiClothes", 2567},
            {"StickerSky", 2568},
            {"SouvenirSky1", 2569},
            {"SouvenirSky2", 2570},
            {"MarioSpaceSuitCap", 2571},
            {"MarioSpaceSuitClothes", 2572},
            {"StickerMoon", 2573},
            {"SouvenirMoon1", 2574},
            {"SouvenirMoon2", 2575},
            {"Mario64Cap", 2576},
            {"Mario64Clothes", 2577},
            {"StickerPeachDokan", 2578},
            {"StickerPeachCoin", 2579},
            {"StickerPeachBlock", 2580},
            {"StickerPeachBlockQuestion", 2581},
            {"StickerPeach", 2582},
            {"SouvenirPeach1", 2583},
            {"SouvenirPeach2", 2584},
            {"MarioShopmanCap", 2585},
            {"MarioShopmanClothes", 2586},
            {"MarioUnderwearClothes", 2587},
            {"MarioNew3DSCap", 2588},
            {"MarioNew3DSClothes", 2589},
            {"MarioMechanicCap", 2590},
            {"MarioMechanicClothes", 2591},
            {"MarioSuitCap", 2592},
            {"MarioSuitClothes", 2593},
            {"MarioPirateCap", 2594},
            {"MarioPirateClothes", 2595},
            {"MarioClownCap", 2596},
            {"MarioClownClothes", 2597},
            {"MarioFootballCap", 2598},
            {"MarioFootballClothes", 2599},
            {"MarioColorClassicCap", 2600},
            {"MarioColorClassicClothes", 2601},
            {"MarioBoneClothes", 2602},
            {"MarioColorLuigiCap", 2603},
            {"MarioColorLuigiClothes", 2604},
            {"MarioDoctorCap", 2605},
            {"MarioDoctorClothes", 2606},
            {"MarioColorWaluigiCap", 2607},
            {"MarioColorWaluigiClothes", 2608},
            {"MarioDiddyKongCap", 2609},
            {"MarioDiddyKongClothes", 2610},
            {"MarioColorWarioCap", 2611},
            {"MarioColorWarioClothes", 2612},
            {"MarioHakamaClothes", 2613},
            {"MarioKoopaCap", 2614},
            {"MarioKoopaClothes", 2615},
            {"MarioPeachCap", 2616},
            {"MarioPeachClothes", 2617},
            {"MarioColorGoldCap", 2618},
            {"MarioColorGoldClothes", 2619},
            {"Mario64MetalCap", 2620},
            {"Mario64MetalClothes", 2621},
            {"MarioKingCap", 2622},
            {"MarioKingClothes", 2623},
            {"Tuxedo Cap", 2624},
            {"Tuxedo Clothes", 2625}
        };
        
        public static readonly Dictionary<int, string> inverseShopItems = new Dictionary<int, string>()
        {
            {2502, "MarioInvisibleCap"},
            {2503 , "MarioCaptainCap"},
            {2504 , "MarioTailCoatCap"},
            {2505 , "MarioTailCoatClothes"},
            {2506 , "StickerCap"},
            {2507 , "SouvenirHat1"},
            {2508 , "SouvenirHat2"},
            {2509 , "MarioPrimitiveManCap"},
            {2510 , "MarioPrimitiveManClothes"},
            {2511 , "StickerWaterfall"},
            {2512 , "SouvenirFall1"},
            {2513 , "SouvenirFall2"},
            {2514 , "MarioPonchoCap"},
            {2515 , "MarioPonchoClothes"},
            {2516 , "MarioGunmanCap"},
            {2517 , "MarioGunmanClothes"},
            {2518 , "StickerSand"},
            {2519 , "SouvenirSand2"},
            {2520 , "SouvenirSand1"},
            {2521 , "MarioSwimwearCap"},
            {2522 , "MarioSwimwearClothes"},
            {2523 , "StickerLake"},
            {2524 , "SouvenirLake2"},
            {2525 , "SouvenirLake1"},
            {2526 , "MarioExplorerCap"},
            {2527 , "MarioExplorerClothes"},
            {2528 , "MarioScientistCap"},
            {2529 , "MarioScientistClothes"},
            {2530 , "StickerForest"},
            {2531 , "SouvenirForest1"},
            {2532 , "SouvenirForest2"},
            {2533 , "MarioPilotCap"},
            {2534 , "MarioPilotClothes"},
            {2535 , "StickerClash"},
            {2536 , "SouvenirCrash1"},
            {2537 , "SouvenirCrash2"},
            {2538 , "MarioMakerCap"},
            {2539 , "MarioMakerClothes"},
            {2540 , "MarioGolfCap"},
            {2541 , "MarioGolfClothes"},
            {2542 , "StickerCity"},
            {2543 , "SouvenirCity2"},
            {2544 , "SouvenirCity1"},
            {2545 , "MarioSnowSuitCap"},
            {2546 , "MarioSnowSuitClothes"},
            {2547 , "StickerSnow"},
            {2548 , "SouvenirSnow1"},
            {2549 , "SouvenirSnow2"},
            {2550 , "MarioAlohaCap"},
            {2551 , "MarioAlohaClothes"},
            {2552 , "MarioSailorCap"},
            {2553 , "MarioSailorClothes"},
            {2554 , "StickerSea"},
            {2555 , "SouvenirSea2"},
            {2556 , "SouvenirSea1"},
            {2557 , "MarioCookCap"},
            {2558 , "MarioCookClothes"},
            {2559 , "MarioPainterCap"},
            {2560 , "MarioPainterClothes"},
            {2561 , "StickerLava"},
            {2562 , "SouvenirLava1"},
            {2563 , "SouvenirLava2"},
            {2564 , "MarioArmorCap"},
            {2565 , "MarioArmorClothes"},
            {2566 , "MarioHappiCap"},
            {2567 , "MarioHappiClothes"},
            {2568 , "StickerSky"},
            {2569 , "SouvenirSky1"},
            {2570 , "SouvenirSky2"},
            {2571 , "MarioSpaceSuitCap"},
            {2572 , "MarioSpaceSuitClothes"},
            {2573 , "StickerMoon"},
            {2574 , "SouvenirMoon1"},
            {2575 , "SouvenirMoon2"},
            {2576 , "Mario64Cap"},
            {2577 , "Mario64Clothes"},
            {2578 , "StickerPeachDokan"},
            {2579 , "StickerPeachCoin"},
            {2580 , "StickerPeachBlock"},
            {2581 , "StickerPeachBlockQuestion"},
            {2582 , "StickerPeach"},
            {2583 , "SouvenirPeach1"},
            {2584 , "SouvenirPeach2"},
            {2585 , "MarioShopmanCap"},
            {2586 , "MarioShopmanClothes"},
            {2587 , "MarioUnderwearClothes"},
            {2588 , "MarioNew3DSCap"},
            {2589 , "MarioNew3DSClothes"},
            {2590 , "MarioMechanicCap"},
            {2591 , "MarioMechanicClothes"},
            {2592 , "MarioSuitCap"},
            {2593 , "MarioSuitClothes"},
            {2594 , "MarioPirateCap"},
            {2595 , "MarioPirateClothes"},
            {2596 , "MarioClownCap"},
            {2597 , "MarioClownClothes"},
            {2598 , "MarioFootballCap"},
            {2599 , "MarioFootballClothes"},
            {2600 , "MarioColorClassicCap"},
            {2601 , "MarioColorClassicClothes"},
            {2602 , "MarioBoneClothes"},
            {2603 , "MarioColorLuigiCap"},
            {2604 , "MarioColorLuigiClothes"},
            {2605 , "MarioDoctorCap"},
            {2606 , "MarioDoctorClothes"},
            {2607 , "MarioColorWaluigiCap"},
            {2608 , "MarioColorWaluigiClothes"},
            {2609 , "MarioDiddyKongCap"},
            {2610 , "MarioDiddyKongClothes"},
            {2611 , "MarioColorWarioCap"},
            {2612 , "MarioColorWarioClothes"},
            {2613 , "MarioHakamaClothes"},
            {2614 , "MarioKoopaCap"},
            {2615 , "MarioKoopaClothes"},
            {2616 , "MarioPeachCap"},
            {2617 , "MarioPeachClothes"},
            {2618 , "MarioColorGoldCap"},
            {2619 , "MarioColorGoldClothes"},
            {2620 , "Mario64MetalCap"},
            {2621 , "Mario64MetalClothes"},
            {2622 , "MarioKingCap"},
            {2623 , "MarioKingClothes"},
            {2624 , "MarioTuxedoCap"},
            {2625 , "MarioTuxedoClothes"}
        };

        public static readonly Dictionary<string, int> darkSideHintArts = new Dictionary<string, int>()
        {
            {"WaterfallWorldHomeStage", 1132},
            {"CityWorldHomeStage", 1130},
            {"PeachWorldHomeStage", 1131},
            {"CloudWorldHomeStage", 1124},
            {"SnowWorldHomeStage", 1129},
            {"SeaWorldHomeStage", 1127},
            {"ClashWorldHomeStage", 1126},
            {"LavaWorldHomeStage", 1123},
            {"LakeWorldHomeStage", 1128},
            {"BossRaidWorldHomeStage", 1125}
        };

        public static readonly int[][] moonList =
        {
            new int[] {
                1019,
                815,
                861,
                227,
                230,
                236,
                237,
                234,
                235,
                238,
                239,
                228,
                1073,
                1038,
                1033,
                229,
                1086,
                233,
                816,
                817,
                1158,
                1025,
                231,
                813,
                1156,
                232,
                1018,
                981,
                1034,
                950,
                951
            },
            new int[] {
                205,
                218,
                206,
                212,
                1145,
                216,
                210,
                208,
                669,
                670,
                204,
                1116,
                1115,
                225,
                226,
                221,
                222,
                1004,
                207,
                211,
                906,
                209,
                708,
                866,
                1041,
                213,
                826,
                214,
                215,
                825,
                823,
                822,
                1167,
                217,
                770,
                894,
                224,
                223,
                673,
                674
            },
            new int[] {
                497,
                496,
                495,
                560,
                517,
                518,
                516,
                523,
                505,
                520,
                507,
                522,
                511,
                506,
                510,
                519,
                508,
                526,
                530,
                1112,
                1113,
                1114,
                525,
                532,
                893,
                509,
                498,
                565,
                564,
                1047,
                533,
                567,
                566,
                1136,
                569,
                562,
                561,
                555,
                554,
                557,
                556,
                504,
                513,
                563,
                953,
                558,
                534,
                512,
                531,
                536,
                539,
                502,
                493,
                692,
                1059,
                501,
                552,
                538,
                995,
                570,
                571,
                524,
                1096,
                910,
                924,
                1045,
                887,
                535,
                544,
                547,
                546,
                799,
                550,
                521,
                542,
                540,
                553,
                545,
                515,
                783,
                965,
                712,
                1046,
                572,
                573,
                575,
                574,
                35,
                36,

            },
            new int[] {
            129,
            159,
            130,
            181,
            134,
            150,
            149,
            148,
            135,
            139,
            143,
            146,
            145,
            140,
            141,
            142,
            144,
            147,
            136,
            133,
            131,
            1026,
            138,
            180,
            179,
            195,
            182,
            183,
            1137,
            1159,
            185,
            186,
            1153,
            184,
            188,
            187,
            157,
            676,
            196,
            197,
            193,
            194,
            191,
            192,
            190,
            189,
            198,
            199,
            1089,
            1011,
            905,
            153,
            155,
            168,
            892,
            160,
            177,
            169,
            161,
            174,
            166,
            156,
            163,
            1010,
            152,
            170,
            151,
            901,
            1001,
            202,
            203,
            200,
            201,
            882,
            137,
            883
            },
            new int[] {
            424,
            411,
            412,
            410,
            404,
            401,
            405,
            415,
            1166,
            715,
            420,
            413,
            402,
            407,
            416,
            409,
            414,
            403,
            430,
            971,
            406,
            1008,
            1009,
            425,
            426,
            1094,
            1078,
            870,
            869,
            871,
            709,
            408,
            422,
            771,
            719,
            1015,
            423,
            1017,
            720,
            434,
            417,
            431
            },
            new int[] {
            982,
            1118,
            851,
            852,
            853,
            1160,
            983,
            914,
            915
            },
            new int[] {
            376,
            380,
            374,
            377,
            384,
            387,
            375,
            385,
            379,
            373,
            942,
            388,
            378,
            386,
            382,
            1075,
            381,
            383,
            372,
            398,
            390,
            1077,
            943,
            832,
            394,
            395,
            396,
            392,
            393,
            897,
            855,
            399,
            400,
            491,
            492
            },
            new int[] {
            42,
            41,
            44,
            43,
            107,
            37,
            95,
            38,
            39,
            54,
            65,
            61,
            59,
            49,
            62,
            77,
            99,
            68,
            1054,
            839,
            70,
            71,
            69,
            46,
            809,
            50,
            101,
            1040,
            60,
            51,
            53,
            105,
            102,
            100,
            1100,
            875,
            1022,
            1023,
            122,
            121,
            114,
            113,
            118,
            119,
            103,
            104,
            115,
            116,
            1139,
            1140,
            1088,
            881,
            40,
            1150,
            97,
            874,
            96,
            904,
            1037,
            979,
            939,
            81,
            848,
            928,
            929,
            75,
            84,
            78,
            74,
            1155,
            938,
            82,
            106,
            940,
            1021,
            949,
            948,
            125,
            126,
            123,
            124
            },
            new int[] {
            438,
            441,
            440,
            439,
            437,
            449,
            455,
            466,
            467,
            450,
            451,
            458,
            459,
            453,
            452,
            445,
            447,
            444,
            1151,
            1024,
            1057,
            448,
            1103,
            1104,
            1106,
            1105,
            468,
            863,
            471,
            454,
            442,
            446,
            474,
            443,
            457,
            460,
            472,
            473,
            1107,
            483,
            1135,
            484,
            485,
            486,
            478,
            479,
            482,
            481,
            1095,
            464,
            1028,
            477,
            780,
            779,
            920,
            476,
            773,
            1043,
            776,
            778,
            775,
            1120,
            475,
            864,
            790,
            1163,
            1029,
            488,
            487,
            489,
            490
            },
            new int[] {
            17,
            22,
            18,
            25,
            1020,
            1081,
            21,
            1080,
            16,
            1002,
            23,
            24,
            678,
            686,
            2,
            3,
            4,
            20,
            694,
            873,
            868,
            877,
            879,
            12,
            13,
            14,
            15,
            33,
            1030,
            1031,
            30,
            831,
            937,
            1087,
            695,
            903,
            19,
            8,
            6,
            7,
            703,
            843,
            10,
            9,
            701,
            704,
            1003,
            699,
            973,
            878,
            900,
            998,
            997,
            31,
            32
            },
            new int[] {
            291,
            251,
            257,
            292,
            290,
            256,
            250,
            253,
            240,
            247,
            248,
            245,
            246,
            254,
            242,
            241,
            243,
            264,
            249,
            711,
            263,
            970,
            244,
            803,
            294,
            1042,
            991,
            990,
            259,
            952,
            255,
            261,
            265,
            992,
            289,
            833,
            302,
            303,
            299,
            298,
            296,
            297,
            300,
            301,
            307,
            306,
            1090,
            269,
            908,
            260,
            907,
            886,
            1005,
            280,
            266,
            268,
            271,
            829,
            287,
            276,
            277,
            895,
            313,
            312,
            310,
            311,
            1101,
            308
            },
            new int[] {
            795,
            793,
            888,
            889,
            1117,
            834,
            835,
            909,
            891,
            890
            },
            new int[] {
            325,
            334,
            314,
            332,
            321,
            333,
            335,
            327,
            340,
            326,
            1133,
            345,
            339,
            319,
            343,
            320,
            691,
            315,
            324,
            1092,
            323,
            337,
            328,
            316,
            317,
            331,
            26,
            318,
            360,
            999,
            987,
            988,
            368,
            367,
            363,
            364,
            365,
            366,
            1039,
            941,
            859,
            1161,
            322,
            338,
            1091,
            350,
            1032,
            1016,
            356,
            1014,
            349,
            355,
            52,
            351,
            1102,
            348,
            1143,
            896,
            801,
            802,
            370,
            369
            },
            new int[] {
            1148,
            1149,
            1141,
            1147,
            1142,
            1146,
            579,
            586,
            577,
            583,
            585,
            582,
            584,
            576,
            595,
            596,
            597,
            594,
            598,
            593,
            693,
            672,
            671,
            580,
            1000,
            1157,
            578,
            707,
            1164,
            599,
            911,
            581,
            1165,
            1049,
            810,
            811,
            798,
            714,
            899,
            828,
            603,
            604,
            601,
            602
            },
            new int[] {
            912,
            1134,
            1027,
            613,
            1108,
            1109,
            1111,
            1110,
            959,
            977,
            840,
            1121,
            607,
            856,
            857,
            858,
            606,
            984,
            605,
            913,
            933,
            967,
            968,
            985,
            986,
            807,
            956,
            934,
            1144,
            974,
            975,
            1050,
            1051,
            608,
            1152,
            978,
            1119
            },
            new int[] {
            1055,
            1122,
            1062,
            1063,
            1069,
            1068,
            1065,
            1064,
            1066,
            1067,
            1070,
            1071,
            1082,
            1083,
            1132,
            1130,
            1131,
            1124,
            1129,
            1127,
            1126,
            1123,
            1128,
            1125
            },
            new int[] {
                1061
            }
        };

        public static readonly Dictionary<long, Goal> goals = new Dictionary<long, Goal>()
        {
            {4, new Goal {item = "Sand Multi-Moon", index = 3} },
            {5, new Goal { item = "Lake Multi-Moon", index = 0 }},
            {9, new Goal { item = "Metro Multi-Moon", index = 6 }},
            {12, new Goal { item = "Luncheon Multi-Moon", index = 4 }},
            {15, new Goal { item = "Beat the Game", index = -1 }},
            {17, new Goal { item = "Dark Side Multi-Moon", index = 0 }},
            {18, new Goal { item = "Darker Side Multi-Moon", index = 0 }}
        };

        public static readonly Dictionary<string, int> worlds = new Dictionary<string, int>()
        {
            { "Cap", 0},
            { "Cascade", 1},
            { "Sand", 2},
            { "Wooded", 3},
            { "Lake", 4},
            { "Cloud", 5},
            { "Lost", 6},
            { "Metro", 7},
            { "Seaside", 8},
            { "Snow", 9},
            { "Luncheon", 10},
            { "Ruined", 11},
            { "Bowser", 12},
            { "Moon", 13},
            { "Mushroom", 14},
            { "Power", 14},
            { "Dark", 15},
            { "Darker", 16}
        };

        private Dictionary<string, int> _moons = new Dictionary<string, int>()
        {
            { "Cap Power Moon", 0},
            { "Cascade Power Moon", 2},
            { "Sand Power Moon", 4},
            { "Wooded Power Moon", 4},
            { "Lake Power Moon", 0},
            { "Cloud Power Moon", 0},
            { "Lost Power Moon", 0},
            { "Metro Power Moon", 7},
            { "Seaside Power Moon", 5},
            { "Snow Power Moon", 5},
            { "Luncheon Power Moon", 5},
            { "Ruined Power Moon", 1},
            { "Bowser Power Moon", 4},
            { "Moon Power Moon", 0},
            { "Power Star", 6},
            { "Dark Side Power Moon", 1},
            { "Cascade Story Moon", 0},
            { "Sand Story Moon", 0},
            { "Wooded Story Moon", 0},
            { "Metro Story Moon", 0},
            { "Seaside Story Moon", 0},
            { "Snow Story Moon", 0},
            { "Luncheon Story Moon", 0},
            { "Bowser Story Moon", 0},
            { "Cascade Multi-Moon", 1},
            { "Sand Multi-Moon", 2},
            { "Wooded Multi-Moon", 2},
            { "Lake Multi-Moon", 0},
            { "Metro Multi-Moon", 5},
            { "Seaside Multi-Moon", 4},
            { "Snow Multi-Moon", 4},
            { "Luncheon Multi-Moon", 3},
            { "Ruined Multi-Moon", 0},
            { "Bowser Multi-Moon", 3},
            { "Mushroom Multi-Moon", 0},
            { "Dark Side Multi-Moon", 0},
            { "Darker Side Multi-Moon", 0},

        };

        public void Connect(string server, string user, string pass, ushort port)
        {
            session = ArchipelagoSessionFactory.CreateSession(server, port);

            try
            {
                // handle TryConnectAndLogin attempt here and save the returned object to `result`
                result = session.TryConnectAndLogin("Super Mario Odyssey", user, ItemsHandlingFlags.AllItems, null, null, null, pass);
            }
            catch (Exception e)
            {
                result = new LoginFailure(e.GetBaseException().Message);
            }

            if (!result.Successful)
            {
                LoginFailure failure = (LoginFailure)result;
                string errorMessage = $"Failed to Connect to {server} as {user}:";
                foreach (string error in failure.Errors)
                {
                    errorMessage += $"\n    {error}";
                }
                foreach (ConnectionRefusedError error in failure.ErrorCodes)
                {
                    errorMessage += $"\n    {error}";
                }

                Console.WriteLine(errorMessage);
                loginFailed = true;
                // Did not connect, show the user the contents of `errorMessage`
                return;
            }

            // Successfully connected, `ArchipelagoSession` (assume statically defined as `session` from now on) can now be used to interact with the server and the
            // returned `LoginSuccessful` contains some useful information about the initial connection (e.g. a copy of the slot data as `loginSuccess.SlotData`)
            Console.WriteLine($"Successfully Connected to {server} as {user}");
            loginFailed = false;
            session.Locations.CompleteLocationChecks(preconnectChecks.ToArray());
            preconnectChecks.Clear();
            loginSuccessful = (LoginSuccessful)result;
            deathLink = session.CreateDeathLinkService();
       }



        
        public void SendLocation(int location)
        {
            if (!loginFailed)
            {
                session.Locations.CompleteLocationChecks(location);
                preconnectChecks.Add(location);
            }
            else
            {
                Console.WriteLine($"Not connected to AP, storing check {location}");
                preconnectChecks.Add(location);
            }
        }

        public string GetErrorMessage()
        {
            LoginFailure failure = (LoginFailure)result;
            string errorMessage = $"Failed to Connect:";
            foreach (string error in failure.Errors)
            {
                errorMessage += $" {error}";
            }
            foreach (ConnectionRefusedError error in failure.ErrorCodes)
            {
                errorMessage += $" {error}";
            }
            return errorMessage;
        }

        public Goal GetGoal()
        {
            return goals[(long)(loginSuccessful.SlotData["goal"])];
        }

        public ushort GetClashCount()
        {
            return (ushort)(loginSuccessful.SlotData["clash"]);
        }

        public ushort GetRaidCount()
        {
            return (ushort)(loginSuccessful.SlotData["raid"]);
        }

        public int GetNextMoon(string itemName)
        {
            int moonId = moonList[worlds[itemName.Split(" ")[0]]][_moons[itemName]];
            _moons[itemName] += 1;
            return moonId;
        }

        public Dictionary<string, int> GetMoons()
        {
            return _moons;
        }

        public void ResetMoons()
        {
            _moons = new Dictionary<string, int>()
            {
                { "Cap Power Moon", 0},
                { "Cascade Power Moon", 2},
                { "Sand Power Moon", 4},
                { "Wooded Power Moon", 4},
                { "Lake Power Moon", 0},
                { "Cloud Power Moon", 0},
                { "Lost Power Moon", 0},
                { "Metro Power Moon", 7},
                { "Seaside Power Moon", 5},
                { "Snow Power Moon", 5},
                { "Luncheon Power Moon", 5},
                { "Ruined Power Moon", 1},
                { "Bowser Power Moon", 4},
                { "Moon Power Moon", 0},
                { "Power Star", 6},
                { "Dark Side Power Moon", 1},
                { "Cascade Story Moon", 0},
                { "Sand Story Moon", 0},
                { "Wooded Story Moon", 0},
                { "Metro Story Moon", 0},
                { "Seaside Story Moon", 0},
                { "Snow Story Moon", 0},
                { "Luncheon Story Moon", 0},
                { "Bowser Story Moon", 0},
                { "Cascade Multi-Moon", 1},
                { "Sand Multi-Moon", 2},
                { "Wooded Multi-Moon", 2},
                { "Lake Multi-Moon", 0},
                { "Metro Multi-Moon", 5},
                { "Seaside Multi-Moon", 4},
                { "Snow Multi-Moon", 4},
                { "Luncheon Multi-Moon", 3},
                { "Ruined Multi-Moon", 0},
                { "Bowser Multi-Moon", 3},
                { "Mushroom Multi-Moon", 0},
				{ "Dark Side Multi-Moon", 0},
				{ "Darker Side Multi-Moon", 0},

            };
        }

    }
}
